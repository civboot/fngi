#include <stddef.h>
#include <stdio.h>
#include <fcntl.h>
#include <assert.h>
#include <errno.h>
#include <string.h>
#include <unistd.h>

#include "../kernel/kernel.h"

U1* header = (
"\\ @file kernel/globals.sp\n"
"\\ DO NOT EDIT MANUALLY! THIS FILE WAS GENERATED BY: etc/make.py\n"
"\\\n"
"\\ @brief Defines global variable offsets.\n"
"\n"
);

int writeto(U1* path) {
  int fd = open(path, O_WRONLY | O_CREAT | O_TRUNC, 00600); assert(fd); return fd;
}

#define WRITE_VAL(FD, NAME, VALUE) \
    assert(dprintf(FD, "#%.2X  #0=k_%s\n", VALUE, NAME) > 0)

#define WRITE_KERN(FD, FIELD)     WRITE_VAL(FD, #FIELD, offsetof(Kern, FIELD))
#define WRITE_GLOBAL(FD, FIELD)   WRITE_VAL(FD, #FIELD, offsetof(Globals, FIELD))

void main() {
  int fd = writeto("kernel/globals.sp");
  assert(dprintf(fd, header) > 0);
  assert(dprintf(fd, "\\ Kernel Data. Note: raw references, not global offsets\n") > 0);
  WRITE_KERN(fd, memTop);
  WRITE_KERN(fd, dict);
  printf("Fiber size: %u\n", sizeof(Fiber));

  assert(dprintf(fd, "\n\\ Kernel Global Offsets\n") > 0);
  WRITE_GLOBAL(fd, err);
  WRITE_GLOBAL(fd, glen); WRITE_GLOBAL(fd, gcap);
  WRITE_GLOBAL(fd, curBBA);
  WRITE_GLOBAL(fd, src);
  assert(dprintf(fd, "\n") > 0);
  close(fd);
}
